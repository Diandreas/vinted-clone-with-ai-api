<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend Auth & Messages</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>Test Authentification & Messages</h1>
    
    <div id="auth-section">
        <h2>1. Test Authentification</h2>
        <div>
            <input type="email" id="email" placeholder="Email" value="njandjeu@gmail.com">
            <input type="password" id="password" placeholder="Mot de passe" value="password">
            <button onclick="testLogin()">Se connecter</button>
        </div>
        <div id="auth-result"></div>
    </div>

    <div id="message-section" style="display: none;">
        <h2>2. Test Envoi Message</h2>
        <div>
            <select id="product-select">
                <option value="5">Produit ID 5 - Robe Mango</option>
                <option value="7">Produit ID 7 - Nike Air Max</option>
                <option value="8">Produit ID 8 - Test</option>
            </select>
            <input type="text" id="message-text" placeholder="Votre message" value="Bonjour, je suis intéressé par votre produit">
            <button onclick="testSendMessage()">Envoyer Message</button>
        </div>
        <div id="message-result"></div>
    </div>

    <div id="conversations-section" style="display: none;">
        <h2>3. Test Conversations</h2>
        <button onclick="testGetConversations()">Mes Discussions</button>
        <button onclick="testGetSellerConversations()">Mes Ventes</button>
        <div id="conversations-result"></div>
    </div>

    <script>
        let authToken = localStorage.getItem('auth_token');
        
        // Configuration Axios
        const api = axios.create({
            baseURL: 'http://localhost:8000/api/v1',
            timeout: 30000,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });

        // Interceptor pour ajouter le token
        api.interceptors.request.use(config => {
            const token = localStorage.getItem('auth_token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        });

        if (authToken) {
            document.getElementById('message-section').style.display = 'block';
            document.getElementById('conversations-section').style.display = 'block';
            document.getElementById('auth-result').innerHTML = '<p style="color: green;">✅ Déjà connecté</p>';
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await axios.post('http://localhost:8000/auth/login', {
                    email: email,
                    password: password
                });
                
                console.log('Login response:', response.data);
                
                // Stocker le token
                authToken = response.data.token;
                localStorage.setItem('auth_token', authToken);
                
                document.getElementById('auth-result').innerHTML = `
                    <p style="color: green;">✅ Connexion réussie!</p>
                    <p>Token: ${authToken.substring(0, 20)}...</p>
                    <p>Utilisateur: ${response.data.user.name}</p>
                `;
                
                document.getElementById('message-section').style.display = 'block';
                document.getElementById('conversations-section').style.display = 'block';
                
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('auth-result').innerHTML = `
                    <p style="color: red;">❌ Erreur de connexion: ${error.response?.data?.message || error.message}</p>
                `;
            }
        }

        async function testSendMessage() {
            const productId = document.getElementById('product-select').value;
            const message = document.getElementById('message-text').value;
            
            try {
                console.log('Sending message:', { productId, message, token: authToken?.substring(0, 20) + '...' });
                
                const response = await api.post(`/conversations/start/${productId}`, {
                    message: message
                });
                
                console.log('Message response:', response.data);
                
                document.getElementById('message-result').innerHTML = `
                    <p style="color: green;">✅ Message envoyé avec succès!</p>
                    <p>Conversation ID: ${response.data.data.id}</p>
                    <p>Produit: ${response.data.data.product?.title || 'N/A'}</p>
                `;
                
            } catch (error) {
                console.error('Message error:', error);
                document.getElementById('message-result').innerHTML = `
                    <p style="color: red;">❌ Erreur envoi message: ${error.response?.data?.message || error.message}</p>
                    <p>Status: ${error.response?.status}</p>
                `;
            }
        }

        async function testGetConversations() {
            try {
                const response = await api.get('/conversations/my-product-discussions');
                console.log('Conversations response:', response.data);
                
                document.getElementById('conversations-result').innerHTML = `
                    <p style="color: green;">✅ Discussions récupérées!</p>
                    <p>Nombre: ${response.data.data.length}</p>
                    <pre>${JSON.stringify(response.data.data, null, 2)}</pre>
                `;
                
            } catch (error) {
                console.error('Conversations error:', error);
                document.getElementById('conversations-result').innerHTML = `
                    <p style="color: red;">❌ Erreur récupération conversations: ${error.response?.data?.message || error.message}</p>
                `;
            }
        }

        async function testGetSellerConversations() {
            try {
                const response = await api.get('/conversations/my-products-with-buyers');
                console.log('Seller conversations response:', response.data);
                
                document.getElementById('conversations-result').innerHTML = `
                    <p style="color: green;">✅ Conversations vendeur récupérées!</p>
                    <p>Nombre de produits: ${response.data.data.length}</p>
                    <pre>${JSON.stringify(response.data.data, null, 2)}</pre>
                `;
                
            } catch (error) {
                console.error('Seller conversations error:', error);
                document.getElementById('conversations-result').innerHTML = `
                    <p style="color: red;">❌ Erreur récupération conversations vendeur: ${error.response?.data?.message || error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>