<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test CreateProduct Simple</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/20 to-green-50/30">
            <div class="max-w-4xl mx-auto px-4 py-8">
                <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Test CreateProduct Corrigé</h1>
                
                <!-- Formulaire de test -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Formulaire de test</h2>
                    
                    <form @submit.prevent="submitProduct" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Titre *</label>
                                <input v-model="form.title" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prix (Fcfa) *</label>
                                <input v-model="form.price" type="number" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie *</label>
                                <select v-model="form.category_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Sélectionnez une catégorie</option>
                                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Condition *</label>
                                <select v-model="form.condition_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Sélectionnez l'état</option>
                                    <option v-for="cond in conditions" :key="cond.id" :value="cond.id">{{ cond.name }}</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                            <textarea v-model="form.description" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Images *</label>
                            <input type="file" @change="handleImageUpload" multiple accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <div class="mt-2 text-sm text-gray-500">Sélectionnez une ou plusieurs images</div>
                        </div>
                        
                        <button type="submit" :disabled="submitting" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50">
                            {{ submitting ? 'Création en cours...' : 'Créer le produit' }}
                        </button>
                    </form>
                </div>
                
                <!-- Résultats -->
                <div v-if="result" class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">Résultat</h2>
                    <pre class="bg-gray-100 p-4 rounded-md overflow-auto">{{ JSON.stringify(result, null, 2) }}</pre>
                </div>
                
                <!-- Erreurs -->
                <div v-if="errors.length > 0" class="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
                    <h3 class="text-lg font-medium text-red-800 mb-2">Erreurs :</h3>
                    <ul class="list-disc list-inside text-red-700">
                        <li v-for="error in errors" :key="error">{{ error }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        
        createApp({
            setup() {
                const form = ref({
                    title: 'Test Produit Corrigé',
                    description: 'Description de test pour ce produit corrigé',
                    price: '29.99',
                    category_id: '',
                    condition_id: ''
                });
                
                const categories = ref([]);
                const conditions = ref([]);
                const submitting = ref(false);
                const result = ref(null);
                const errors = ref([]);
                
                const loadCategories = async () => {
                    try {
                        const response = await axios.get('/api/v1/categories');
                        categories.value = response.data.data || response.data;
                        console.log('Catégories chargées:', categories.value);
                    } catch (error) {
                        console.error('Erreur chargement catégories:', error);
                    }
                };
                
                const loadConditions = async () => {
                    try {
                        const response = await axios.get('/api/v1/conditions');
                        conditions.value = response.data.data || response.data;
                        console.log('Conditions chargées:', conditions.value);
                    } catch (error) {
                        console.error('Erreur chargement conditions:', error);
                    }
                };
                
                const handleImageUpload = (event) => {
                    form.value.images = Array.from(event.target.files);
                    console.log('Images sélectionnées:', form.value.images);
                };
                
                const submitProduct = async () => {
                    submitting.value = true;
                    errors.value = [];
                    result.value = null;
                    
                    try {
                        const formData = new FormData();
                        
                        // Champs texte
                        formData.append('title', form.value.title);
                        formData.append('description', form.value.description);
                        formData.append('price', form.value.price);
                        formData.append('category_id', form.value.category_id);
                        formData.append('condition_id', form.value.condition_id);
                        
                        // Images
                        if (form.value.images) {
                            form.value.images.forEach((image, index) => {
                                formData.append(`images[${index}]`, image);
                            });
                        }
                        
                        console.log('Envoi des données:', {
                            title: form.value.title,
                            description: form.value.description,
                            price: form.value.price,
                            category_id: form.value.category_id,
                            condition_id: form.value.condition_id,
                            imagesCount: form.value.images ? form.value.images.length : 0
                        });
                        
                        const response = await axios.post('/api/v1/products', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            }
                        });
                        
                        result.value = response.data;
                        console.log('Produit créé avec succès:', response.data);
                        
                    } catch (error) {
                        console.error('Erreur création produit:', error);
                        
                        if (error.response?.data?.errors) {
                            const errorMessages = [];
                            Object.entries(error.response.data.errors).forEach(([field, messages]) => {
                                messages.forEach(message => {
                                    errorMessages.push(`${field}: ${message}`);
                                });
                            });
                            errors.value = errorMessages;
                        } else {
                            errors.value = [error.message || 'Erreur inconnue'];
                        }
                    } finally {
                        submitting.value = false;
                    }
                };
                
                onMounted(() => {
                    loadCategories();
                    loadConditions();
                });
                
                return {
                    form,
                    categories,
                    conditions,
                    submitting,
                    result,
                    errors,
                    handleImageUpload,
                    submitProduct
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
